'''


$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
ì½”ë“œ ì°¸ê³  ì˜ìƒ!
https://youtu.be/YdEdM-oC0kc
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$


$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

ë°±í…ŒìŠ¤íŒ…ì€ ë‚´PCì—ì„œ í•´ì•¼ ì„œë²„ ìì›ì„ ì•„ë¼ê³  íˆ¬ì ì„±ê³¼ ê·¸ë˜í”„ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
ì´ í¬ìŠ¤íŒ…ì„ ì •ë…í•˜ì‹œê³  ë‹¤ì–‘í•œ ê¸°ê°„ìœ¼ë¡œ ë°±í…ŒìŠ¤íŒ… í•´ë³´ì„¸ìš”!!!
https://blog.naver.com/zacra/223180500307

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$


ì¼ë‹¨ ë¹„ì¤‘ ì¡°ì ˆì„ ìœ„í•œ ëª¨ë©˜í…€1,2 (Average_Momentum, prevChangeMa)ê°€ ë³€ê²½ë˜ì—ˆê³  í•„í„°ì¡°ê±´ì´ ê°•í™”ê°€ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.


ì½”ìŠ¤ë‹¥ ëŒíŒŒ ë§¤ë§¤í•  ë•Œ ì¸ë²„ìŠ¤ì˜ ê²½ìš° ì „ì¼,ì „ì „ì¼ ê³ ê°€ì¤‘ í°ê±°, ì „ì¼,ì „ì „ì¼ ì €ê°€ì¤‘ ì‘ì€ê±°ë¡œ ë ˆì¸ì§€ë¥¼ êµ¬í•´ ë³€ëŒì„ í•˜ê³ ìš”.
ë ˆë²„ë¦¬ì§€ì˜ ê²½ìš° í•„í„°ë¥¼ ê°•í™”í–ˆìŠµë‹ˆë‹¹.


ë˜ ëŒíŒŒ ë§¤ë§¤ì‹œ ì‚¬ìš© ë˜ëŠ” DolpaRate ê°€ 60,20ì´í‰ì„ ì„ ì‚¬ìš©í•˜ê²Œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.
ì„¸ë¶€ì ì¸ ì‚¬í•­ì€ ê¸°ì¡´ ì½”ë“œë¥¼ ë³´ì…¨ìœ¼ë‹ˆ ì´ë²ˆ ì½”ë“œë‘ ë¹„êµí•´ ë³´ì‹œë©´ ë  ë“¯ í•©ë‹ˆë‹¤.


ì½”ìŠ¤ë‹¥ ì½”ìŠ¤í”¼ ì–‘ë°©í–¥ìœ¼ë¡œ íˆ¬ìí•˜ëŠ” ì „ëµ! ì´ˆì „ë„ì²´ LK99ì— ë²„ê¸ˆê°€ëŠ” ë°œê²¬!!
https://blog.naver.com/zacra/223177598281

OBV í™œìš© ì¶”ê°€!
https://blog.naver.com/zacra/223986975517


ì´ë¯¸ ì˜ ì•„ì‹œê² ì§€ë§Œ ë ˆë²„ë¦¬ì§€ ETFë¥¼ ë§¤ë§¤í•˜ë ¤ë©´ ì‚¬ì „ ì¡°ê±´ë“±ì´ ìˆëŠ”ë° ì•„ë˜ í¬ìŠ¤íŒ…ì— ì •ë¦¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

https://blog.naver.com/zacra/223180937351


ë°±í…ŒìŠ¤íŒ… ì½”ë“œ ë³´ì‹œë©´ ì‚¬ìš©í•˜ì§€ëŠ” ì•Šì•˜ì§€ë§Œ
ë³¼ë¦°ì € ë°´ë“œ ê°’ì„ êµ¬í•˜ëŠ” ë¶€ë¶„ë„ ìˆìœ¼ë¯€ë¡œ ì°¨í›„ ë‹¤ë¥¸ ê³³ì— ì‘ìš©í•´ì„œ í™œìš©í•˜ì…”ë„ ì¢‹ì„ ê²ƒ ê°™ë„¤ìš”.


ğŸ“Œ ê²Œë§Œì•„ì˜ ëª¨ë“  ì½”ë“œëŠ” íŠ¹ì • ì¢…ëª© ì¶”ì²œì´ë‚˜ íˆ¬ì ê¶Œìœ ë¥¼ ìœ„í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.  
ì œê³µëœ ì „ëµì€ í•™ìŠµ ë° í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œ êµ¬ì„±ëœ ì˜ˆì‹œ ì½”ë“œì´ë©°
ì‹¤ì œ íˆ¬ì íŒë‹¨ ë° ì‹¤í–‰ì€ ì „ì ìœ¼ë¡œ ì‚¬ìš©ì ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.
   

ì£¼ì‹/ì½”ì¸ ìë™ë§¤ë§¤ FAQ
https://blog.naver.com/zacra/223203988739

FAQë¡œ í•´ê²° ì•ˆë˜ëŠ” ê¸°ìˆ ì ì¸ ë¬¸ì œëŠ” í´ë˜ìŠ¤101 ê°•ì˜ì˜ ëŒ“ê¸€ì´ë‚˜ ìœ„ í¬ìŠ¤íŒ…ì— ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.
íŒŒì´ì¬ ì½”ë”©ì— ëŒ€í•œ ë‹µë³€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„í–‰ë²• ìƒ íˆ¬ì ê´€ë ¨ ì§ˆë¬¸ì€ ë‹µë³€ ë¶ˆê°€í•˜ë‹¤ëŠ” ì  ì•Œë ¤ë“œë ¤ìš”!
   
'''

import KIS_Common as Common
import KIS_API_Helper_KR as KisKR
import pandas as pd
import pprint
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime
from pykrx import stock


#ê³„ì¢Œ ì„ íƒ.. "VIRTUAL" ëŠ” ëª¨ì˜ ê³„ì¢Œ!
Common.SetChangeMode("VIRTUAL") #REAL or VIRTUAL


##############################################################################
InvestStockList = ["122630","252670","233740","251340"] #í…ŒìŠ¤íŠ¸í•  ì¢…ëª©
##############################################################################


StartYear = 2017

fee = 0.0015 #ìˆ˜ìˆ˜ë£Œ+ì„¸ê¸ˆ+ìŠ¬ë¦¬í”¼ì§€ë¥¼ ë§¤ìˆ˜ë§¤ë„ë§ˆë‹¤ 0.15%ë¡œ ì„¸íŒ…!
#ì´ë ‡ê²Œ ì§ì ‘ ê¸ˆì•¡ì„ ì§€ì •
TotalMoney = 10000000

print("í…ŒìŠ¤íŠ¸í•˜ëŠ” ì´ ê¸ˆì•¡: ", format(round(TotalMoney), ','))



StockDataList = list()

for stock_code in InvestStockList:
    print("..",stock_code,"..")
    stock_data = dict()
    stock_data['stock_code'] = stock_code
    stock_data['stock_name'] = KisKR.GetStockName(stock_code)
    stock_data['try'] = 0
    stock_data['success'] = 0
    stock_data['fail'] = 0
    stock_data['accRev'] = 0

    StockDataList.append(stock_data)

pprint.pprint(StockDataList)



def GetStockName(stock_code, StockDataList):
    result_str = stock_code
    for stock_data in StockDataList:
        if stock_code == stock_data['stock_code']:
            result_str = stock_data['stock_name']
            break

    return result_str
    

stock_df_list = []

gugan_lenth = 7

for stock_code in InvestStockList:
    df = Common.GetOhlcv("KR", stock_code,2200)
    df['value_median'] = df['value'].shift(1).rolling(window=20).median()

    #########################################################################################
    #OBV í™œìš©! 
    # OBV ê³„ì‚°
    df['direction'] = 0
    df.loc[df['close'] > df['close'].shift(1), 'direction'] = 1
    df.loc[df['close'] < df['close'].shift(1), 'direction'] = -1
    df['obv'] = (df['direction'] * df['volume']).cumsum()

    # OBV ì´ë™í‰ê· ì„ 
    df['obv_ma'] = df['obv'].rolling(window=10).mean()
    
    df['prev_obv_ma'] = df['obv_ma'].shift(1)
    df['prev_obv_ma2'] = df['obv_ma'].shift(2)
    df['prev_obv'] = df['obv'].shift(1)

    #########################################################################################
    
    
    ########## ë³¼ë¦°ì € ë°´ë“œ ì§€í‘œ êµ¬í•˜ëŠ” ë¡œì§! ##########
    unit = 2.0
    period = 20

    df['bb_ma'] = df['close'].rolling(period).mean()
    df['stddev'] = df['close'].rolling(period).std()

    df['bb_upper'] = df['bb_ma'] + ( unit * df['stddev'])
    df['bb_lower'] = df['bb_ma'] - ( unit * df['stddev'])

    ########################################

    df['prev_bb_upper'] = df['bb_upper'].shift(1)
    df['prev_bb_lower'] = df['bb_lower'].shift(1)

    df['prev_bb_upper2'] = df['bb_upper'].shift(2)
    df['prev_bb_lower2'] = df['bb_lower'].shift(2)


    period = 14

    delta = df["close"].diff()
    up, down = delta.copy(), delta.copy()
    up[up < 0] = 0
    down[down > 0] = 0
    _gain = up.ewm(com=(period - 1), min_periods=period).mean()
    _loss = down.abs().ewm(com=(period - 1), min_periods=period).mean()
    RS = _gain / _loss

    df['RSI'] = pd.Series(100 - (100 / (1 + RS)), name="RSI")

    df['ma5_rsi_before'] = df['RSI'].rolling(5).mean().shift(1)
    df['ma5_rsi_before2'] = df['RSI'].rolling(5).mean().shift(2)

    df['prevRSI'] = df['RSI'].shift(1)
    df['prevRSI2'] = df['RSI'].shift(2)
    
    df['high_'+str(gugan_lenth)+'_max'] = df['high'].rolling(window=gugan_lenth).max().shift(1)
    df['low_'+str(gugan_lenth)+'_min'] = df['low'].rolling(window=gugan_lenth).min().shift(1)
    
    

    df['prevVolume'] = df['volume'].shift(1)
    df['prevVolume2'] = df['volume'].shift(2)
    df['prevVolume3'] = df['volume'].shift(3)

    df['prevValue'] = df['value'].shift(1)
    df['prevClose'] = df['close'].shift(1)
    df['prevOpen'] = df['open'].shift(1)
    df['prevOpen2'] = df['open'].shift(2)

    df['prevHigh'] = df['high'].shift(1)
    df['prevHigh2'] = df['high'].shift(2)
    df['prevHigh3'] = df['high'].shift(3)
    df['prevLow'] = df['low'].shift(1)
    df['prevLow2'] = df['low'].shift(2)
    df['prevLow3'] = df['low'].shift(3)


    df['Disparity60'] = df['prevClose'] / df['prevClose'].rolling(window=60).mean() * 100.0
    
    df['Disparity20'] = df['prevClose'] / df['prevClose'].rolling(window=20).mean() * 100.0
    
    df['Disparity10'] = df['prevClose'] / df['prevClose'].rolling(window=10).mean() * 100.0

    df['ma5_before'] = df['close'].rolling(5).mean().shift(1)
    df['ma5_before2'] = df['close'].rolling(5).mean().shift(2)

    df['ma3_before'] = df['close'].rolling(3).mean().shift(1)
    df['ma6_before'] = df['close'].rolling(6).mean().shift(1)
    df['ma19_before'] = df['close'].rolling(19).mean().shift(1)


    df['ma10_before'] = df['close'].rolling(10).mean().shift(1)


    df['maC_before'] = df['close'].rolling(20).mean().shift(1)


    df['ma20_before'] = df['close'].rolling(20).mean().shift(1)
    df['ma20_before2'] = df['close'].rolling(20).mean().shift(2)
    df['ma60_before'] = df['close'].rolling(60).mean().shift(1)
    df['ma60_before2'] = df['close'].rolling(60).mean().shift(2)
    
    df['ma75_before'] = df['close'].rolling(75).mean().shift(1)


    df['ma120_before'] = df['close'].rolling(120).mean().shift(1)


    df['value_ma'] = df['value'].rolling(window=10).max().shift(1)


    df['prevChangeMa'] = df['change'].shift(1).rolling(window=50).mean()


    df['prevChangeMa_S'] = df['change'].shift(1).rolling(window=10).mean()

    # Define the list of specific trading days to compare
    specific_days = list()

    for i in range(1,11):
        st = i * 20
        specific_days.append(st)



    # Iterate over the specific trading days and compare the current market price with the corresponding closing prices
    for day in specific_days:
        # Create a column name for each specific trading day
        column_name = f'Momentum_{day}'
        
        # Compare current market price with the closing price of the specific trading day
        df[column_name] = (df['prevClose'] > df['close'].shift(day)).astype(int)

    # Calculate the average momentum score
    df['Average_Momentum'] = df[[f'Momentum_{day}' for day in specific_days]].sum(axis=1) / 10



    # Define the list of specific trading days to compare
    specific_days = list()

    for i in range(1,11):
        st = i * 3
        specific_days.append(st)



    # Iterate over the specific trading days and compare the current market price with the corresponding closing prices
    for day in specific_days:
        # Create a column name for each specific trading day
        column_name = f'Momentum_{day}'
        
        # Compare current market price with the closing price of the specific trading day
        df[column_name] = (df['prevClose'] > df['close'].shift(day)).astype(int)

    # Calculate the average momentum score
    df['Average_Momentum3'] = df[[f'Momentum_{day}' for day in specific_days]].sum(axis=1) / 10






    df.dropna(inplace=True) #ë°ì´í„° ì—†ëŠ”ê±´ ë‚ ë¦°ë‹¤!

   

    data_dict = {stock_code: df}
    stock_df_list.append(data_dict)
    print("---stock_code---", stock_code , " len ",len(df))
    pprint.pprint(df)





# Combine the OHLCV data into a single DataFrame
combined_df = pd.concat([list(data_dict.values())[0].assign(stock_code=stock_code) for data_dict in stock_df_list for stock_code in data_dict])

# Sort the combined DataFrame by date
combined_df.sort_index(inplace=True)

pprint.pprint(combined_df)
print(" len(combined_df) ", len(combined_df))



IsBuy = False #ë§¤ìˆ˜ í–ˆëŠ”ì§€ ì—¬ë¶€
BUY_PRICE = 0  #ë§¤ìˆ˜í•œ ê¸ˆì•¡! 

TryCnt = 0      #ë§¤ë§¤íšŸìˆ˜
SuccesCnt = 0   #ìµì ˆ ìˆ«ì
FailCnt = 0     #ì†ì ˆ ìˆ«ì


IsFirstDateSet = False
FirstDateStr = ""
FirstDateIndex = 0


NowInvestCode = ""
InvestMoney = TotalMoney


DivNum = len(InvestStockList)

RemainInvestMoney = InvestMoney






ResultList = list()

TotalMoneyList = list()

NowInvestList = list()


IsCut = False
IsCutCnt = 0


i = 0
# Iterate over each date
for date in combined_df.index.unique():
     #ë‚ ì§œ ì •ë³´ë¥¼ íšë“
    date_format = "%Y-%m-%d %H:%M:%S"
    date_object = None

    try:
        date_object = datetime.strptime(str(date), date_format)
    
    except Exception as e:
        try:
            date_format = "%Y%m%d"
            date_object = datetime.strptime(str(date), date_format)

        except Exception as e2:
            date_format = "%Y-%m-%d"
            date_object = datetime.strptime(str(date), date_format)




    all_stocks = combined_df.loc[combined_df.index == date].groupby('stock_code')['close'].max().nlargest(DivNum)
    

    #######################################################################################################################################
    #íš¡ë³´ì¥ì„ ì •ì˜í•˜ê¸° ìœ„í•œ ë¡œì§!!
    # https://blog.naver.com/zacra/223225906361 ì´ í¬ìŠ¤íŒ…ì„ ì •ë…í•˜ì„¸ìš”!!!
    Kosdaq_Long_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "233740")]
    Kosdaq_Short_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "251340")]
    Kospi_Long_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "122630")]
    Kospi_Short_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "252670")]
    
    IsNoWay = False
    if len(Kosdaq_Long_Data) == 1 and len(Kosdaq_Short_Data) == 1 and len(Kospi_Long_Data) == 1 and len(Kospi_Short_Data) == 1:
        if  (Kospi_Long_Data['prevChangeMa_S'].values[0] > 0 and Kospi_Short_Data['prevChangeMa_S'].values[0] > 0) or (Kospi_Long_Data['prevChangeMa_S'].values[0] < 0 and Kospi_Short_Data['prevChangeMa_S'].values[0] < 0)  or (Kosdaq_Long_Data['prevChangeMa_S'].values[0] > 0 and Kosdaq_Short_Data['prevChangeMa_S'].values[0] > 0) or (Kosdaq_Long_Data['prevChangeMa_S'].values[0] < 0 and Kosdaq_Short_Data['prevChangeMa_S'].values[0] < 0) :
            IsNoWay = True
    #######################################################################################################################################




    i += 1


    today_sell_code = list()



    items_to_remove = list()



    Kosdaq_sell_cnt = 0

    Kosdaq_sell_money_furture = 0



    #íˆ¬ìì¤‘ì¸ í‹°ì»¤!!
    for investData in NowInvestList:
       # pprint.pprint(investData)

        stock_code = investData['stock_code'] 
        
        if investData['InvestMoney'] > 0:
            stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)]

            if len(stock_data) == 1:

                ####!!!!ì½”ìŠ¤ë‹¥ ì „ëµ!!!####
                #ì¡°ê±´ ë§Œì¡±ì‹œ ë§¤ë„ í•œë‹¤!
                if stock_code in ["233740","251340"]:
                    
                        
                    NowOpenPrice = stock_data['open'].values[0]
                    PrevOpenPrice = stock_data['prevOpen'].values[0] 
                    PrevClosePrice = stock_data['prevClose'].values[0] 


                    CutRate = 0.4

                    #ëŒíŒŒ ê¸°ì¤€ ì´í‰ì„  ë‹¤ë³€í™”!
                    if stock_code == "251340":

                     
                        if PrevClosePrice > stock_data['ma75_before'].values[0]:
                            CutRate = 0.5
                        else:
                            CutRate = 0.3
                        #'''


                    else:

                        if PrevClosePrice > stock_data['ma75_before'].values[0]:

                            if PrevClosePrice > stock_data['ma20_before'].values[0]:
                                CutRate = 0.4
                            else:
                                CutRate = 0.3

                        else:


                            if PrevClosePrice > stock_data['ma20_before'].values[0]:
                                CutRate = 0.3
                            else:
                                CutRate = 0.25


    


                    CutPrice = stock_data['open'].values[0] - ((stock_data['prevHigh'].values[0] - stock_data['prevLow'].values[0]) * CutRate)


                    
                    #if  stock_data['ma20_before2'].values[0] <  stock_data['ma20_before'].values[0]:
                    #    CutPrice = stock_data['open'].values[0] - ((max(stock_data['prevHigh'].values[0],stock_data['prevHigh2'].values[0])- min(stock_data['prevLow'].values[0],stock_data['prevLow2'].values[0])) * CutRate)


                    SellPrice = NowOpenPrice


                    IsSellGo = False




                    if CutPrice >= stock_data['low'].values[0]:
                        IsSellGo = True
                        SellPrice = CutPrice

                    #if stock_code == "251340":
                    #    if stock_data['prevLow'].values[0] > stock_data['open'].values[0]:
                    #        IsSellGo = True


                    #ì§„ì…(ë§¤ìˆ˜)ê°€ê²© ëŒ€ë¹„ ë³€ë™ë¥ 
                    Rate = (SellPrice* (1.0 - fee) - investData['BuyPrice']) / investData['BuyPrice']


                    RevenueRate = (Rate - fee)*100.0 #ìˆ˜ìµë¥  ê³„ì‚°



                    if investData['DolPaCheck'] == False:
                        investData['DolPaCheck'] = True
                        investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((SellPrice - investData['BuyPrice'] ) / investData['BuyPrice'] ))
                    else:
                        investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((SellPrice - PrevOpenPrice ) / PrevOpenPrice))



                    if IsSellGo == True :



                        Kosdaq_sell_cnt += 1 #ì½”ìŠ¤ë‹¥ ëŒíŒŒ ë§¤ë„ê°€ ì¼ì–´ë‚œ ë‚ !

                        ReturnMoney = (investData['InvestMoney'] * (1.0 - fee))  #ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ, ìŠ¬ë¦¬í”¼ì§€ ë°˜ì˜!

                        if RevenueRate < 0:
                            IsCut = True
                            IsCutCnt += 1
                        else:
                            IsCut = False
                            IsCutCnt -= 1
                            if IsCutCnt < 0:
                                IsCutCnt = 0


                        if NowOpenPrice > CutPrice:
                            Kosdaq_sell_money_furture += ReturnMoney

                        TryCnt += 1

                        if RevenueRate > 0: #ìˆ˜ìµë¥ ì´ 0ë³´ë‹¤ í¬ë‹¤ë©´ ìµì ˆí•œ ì…ˆì´ë‹¤!
                            SuccesCnt += 1
                        else:
                            FailCnt += 1
            
                        #ì¢…ëª©ë³„ ì„±ê³¼ë¥¼ ê¸°ë¡í•œë‹¤.
                        for stock_data in StockDataList:
                            if stock_code == stock_data['stock_code']:
                                stock_data['try'] += 1
                                if RevenueRate > 0:
                                    stock_data['success'] += 1
                                else:
                                    stock_data['fail'] +=1
                                stock_data['accRev'] += RevenueRate


                        
                        RemainInvestMoney += ReturnMoney
                        investData['InvestMoney'] = 0


                        #pprint.pprint(NowInvestList)

                        NowInvestMoney = 0
                        for iData in NowInvestList:
                            NowInvestMoney += iData['InvestMoney']

                        InvestMoney = RemainInvestMoney + NowInvestMoney

                        print(GetStockName(stock_code, StockDataList), "(",stock_code, ") ", str(date), " " ,i, " >>>>>>>>>>>>>>>>> ë§¤ë„! ë§¤ìˆ˜ì¼:",investData['Date']," ë§¤ìˆ˜ê°€:",str(investData['BuyPrice']) ," ë§¤ìˆ˜ê¸ˆ:",str(investData['FirstMoney'])," ìˆ˜ìµë¥ : ", round(RevenueRate,2) , "%", " ,íšŒìˆ˜ê¸ˆ:", round(ReturnMoney,2)  , " ë§¤ë„ê°€", SellPrice * (1.0 - fee))
                                
                        items_to_remove.append(investData)

                        today_sell_code.append(stock_code)

                ####!!!!ì½”ìŠ¤í”¼ ì „ëµ!!!####
                #ì¡°ê±´ ë§Œì¡±ì‹œ ë§¤ë„ í•œë‹¤!
                else:
                    

                    NowOpenPrice = stock_data['open'].values[0]
                    PrevOpenPrice = stock_data['prevOpen'].values[0] 
                    PrevClosePrice = stock_data['prevClose'].values[0] 


                    SellPrice = NowOpenPrice

 
                    IsSellGo = False


                    if investData['DolPaCheck'] == False:
                        investData['DolPaCheck'] = True
                        investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((SellPrice - investData['BuyPrice'] ) / investData['BuyPrice'] ))
                    else:
                        investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((SellPrice - PrevOpenPrice ) / PrevOpenPrice))


                    #ì§„ì…(ë§¤ìˆ˜)ê°€ê²© ëŒ€ë¹„ ë³€ë™ë¥ 
                    Rate = (SellPrice* (1.0 - fee) - investData['BuyPrice']) / investData['BuyPrice']

                    RevenueRate = (Rate - fee)*100.0 #ìˆ˜ìµë¥  ê³„ì‚°
                    
                    
                    if stock_code == "252670":
                        
                        if stock_data['Disparity10'].values[0] > 105:
                            #
                            if  PrevClosePrice < stock_data['ma3_before'].values[0]: 
                                IsSellGo = True

                        else:
                            #
                            if PrevClosePrice < stock_data['ma6_before'].values[0] and PrevClosePrice < stock_data['ma19_before'].values[0] : 
                                IsSellGo = True

                    else:
                        print("")
                        
            
                        total_volume = (stock_data['prevVolume'].values[0]+ stock_data['prevVolume2'].values[0] +stock_data['prevVolume3'].values[0]) / 3.0

                        Disparity = stock_data['Disparity20'].values[0] 

                        if (stock_data['prevLow2'].values[0] < stock_data['prevLow'].values[0] or stock_data['prevVolume'].values[0] < total_volume) and (Disparity < 98 or Disparity > 105):
                            print("hold..")
                        else:
                            IsSellGo = True
                    

             
             


                    if IsSellGo == True :


                        ReturnMoney = (investData['InvestMoney'] * (1.0 - fee))  #ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ, ìŠ¬ë¦¬í”¼ì§€ ë°˜ì˜!


                        TryCnt += 1

                        if RevenueRate > 0: #ìˆ˜ìµë¥ ì´ 0ë³´ë‹¤ í¬ë‹¤ë©´ ìµì ˆí•œ ì…ˆì´ë‹¤!
                            SuccesCnt += 1
                        else:
                            FailCnt += 1
            
                        #ì¢…ëª©ë³„ ì„±ê³¼ë¥¼ ê¸°ë¡í•œë‹¤.
                        for stock_data in StockDataList:
                            if stock_code == stock_data['stock_code']:
                                stock_data['try'] += 1
                                if RevenueRate > 0:
                                    stock_data['success'] += 1
                                else:
                                    stock_data['fail'] +=1
                                stock_data['accRev'] += RevenueRate


                        
                        RemainInvestMoney += ReturnMoney
                        investData['InvestMoney'] = 0


                        #pprint.pprint(NowInvestList)

                        NowInvestMoney = 0
                        for iData in NowInvestList:
                            NowInvestMoney += iData['InvestMoney']

                        InvestMoney = RemainInvestMoney + NowInvestMoney

                        print(GetStockName(stock_code, StockDataList), "(",stock_code, ") ", str(date), " " ,i, " >>>>>>>>>>>>>>>>> ë§¤ë„! ë§¤ìˆ˜ì¼:",investData['Date']," ë§¤ìˆ˜ê°€:",str(investData['BuyPrice']) ," ë§¤ìˆ˜ê¸ˆ:",str(investData['FirstMoney'])," ìˆ˜ìµë¥ : ", round(RevenueRate,2) , "%", " ,íšŒìˆ˜ê¸ˆ:", round(ReturnMoney,2)  , " ë§¤ë„ê°€", SellPrice * (1.0 - fee))
                                
                        items_to_remove.append(investData)

                        today_sell_code.append(stock_code)


    #ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
    for item in items_to_remove:
        NowInvestList.remove(item)




    #ìµœëŒ€ 2ê°œ ì¢…ëª©ë§Œ íˆ¬ì ê°€ëŠ¥í•¨! ì½”ìŠ¤í”¼ ë§¤ìˆ˜ ì¡°ê±´ ì²´í¬!
    #ì¦‰ ì½”ìŠ¤í”¼ ë¨¼ì € ë§¤ìˆ˜ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ì—¬ ë§¤ìˆ˜í•œë‹¤!
    if len(NowInvestList) < 2 and int(date_object.strftime("%Y")) >= StartYear:

        if IsFirstDateSet == False:
            FirstDateStr = str(date)
            FirstDateIndex = i-1
            IsFirstDateSet = True



        for stock_code in all_stocks.index:

            IsAlReadyInvest = False
            for investData in NowInvestList:
                if stock_code == investData['stock_code']: 
                    IsAlReadyInvest = True
                    break    
            

            if stock_code not in today_sell_code and IsAlReadyInvest == False:


                stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)]

                ####!!!!ì½”ìŠ¤í”¼ ì „ëµ!!!####
                if stock_code in ["122630","252670"]:
                    

                    PrevClosePrice = stock_data['prevClose'].values[0] 
                    
                    DolPaPrice = stock_data['open'].values[0]


                    IsBuyGo = False
                    
                    
                    # KODEX 200ì„ ë¬¼ì¸ë²„ìŠ¤2X
                    if stock_code == "252670":


                        if PrevClosePrice > stock_data['ma3_before'].values[0]  and PrevClosePrice > stock_data['ma6_before'].values[0]  and PrevClosePrice > stock_data['ma19_before'].values[0] and stock_data['prevRSI'].values[0] < 70 and stock_data['prevRSI2'].values[0] < stock_data['prevRSI'].values[0]:
                            if (stock_data['prevVolume2'].values[0] < stock_data['prevVolume'].values[0]) and (stock_data['prevLow2'].values[0] < stock_data['prevLow'].values[0]) and PrevClosePrice > stock_data['ma60_before'].values[0] and stock_data['ma60_before2'].values[0] < stock_data['ma60_before'].values[0]  and stock_data['ma3_before'].values[0]  > stock_data['ma6_before'].values[0]  > stock_data['ma19_before'].values[0]  :
                                IsBuyGo = True
                    # KODEX ë ˆë²„ë¦¬ì§€
                    else:

                        #'''
                        Disparity = stock_data['Disparity20'].values[0] 
                        
                        if (stock_data['prevLow2'].values[0] < stock_data['prevLow'].values[0]) and (Disparity < 98 or Disparity > 106) and stock_data['prevRSI'].values[0] < 80 :
                            IsBuyGo = True
                        #Ã¥'''
        


                    #ì¡°ê±´ì„ ë§Œì¡±í–ˆë‹¤ë©´ ë§¤ìˆ˜ ê³ ê³ !
                    if IsBuyGo == True :


                        Rate = 1.0




                        print("len(NowInvestList): ", len(NowInvestList))
                        if IsNoWay == True:
                            InvestGoMoney = ((RemainInvestMoney - Kosdaq_sell_money_furture) / len(InvestStockList)) * Rate

                        else:
                     
                            if len(NowInvestList) + Kosdaq_sell_cnt == 0:

                                InvestGoMoney = (RemainInvestMoney - Kosdaq_sell_money_furture) * 0.5 * Rate

                            else:
                                InvestGoMoney = (RemainInvestMoney - Kosdaq_sell_money_furture) * Rate
                    
                   

                        if Rate > 0:


                            BuyAmt = int(InvestGoMoney /  DolPaPrice) #ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ì„ êµ¬í•œë‹¤!

                            NowFee = (BuyAmt*DolPaPrice) * fee



                            #ë§¤ìˆ˜í•´ì•¼ ë˜ëŠ”ë° ë‚¨ì€ëˆì´ ë¶€ì¡±í•˜ë‹¤ë©´ ìˆ˜ëŸ‰ì„ í•˜ë‚˜ì”© ê°ì†Œì‹œì¼œ ë§Œì¡±í•  ë•Œ ë§¤ìˆ˜í•œë‹¤!!
                            while (RemainInvestMoney - Kosdaq_sell_money_furture)   < (BuyAmt*DolPaPrice) + NowFee:
                                if (RemainInvestMoney - Kosdaq_sell_money_furture)   > DolPaPrice:
                                    BuyAmt -= 1
                                    NowFee = (BuyAmt*DolPaPrice) * fee
                                else:
                                    break
                            
                            if BuyAmt > 0:



                                RealInvestMoney = (BuyAmt*DolPaPrice) #ì‹¤ì œ ë“¤ì–´ê°„ íˆ¬ìê¸ˆ

                                RemainInvestMoney -= (BuyAmt*DolPaPrice) #ë‚¨ì€ íˆ¬ìê¸ˆ!
                                RemainInvestMoney -= NowFee


                                InvestData = dict()

                                InvestData['stock_code'] = stock_code
                                InvestData['InvestMoney'] = RealInvestMoney
                                InvestData['FirstMoney'] = RealInvestMoney
                                InvestData['BuyPrice'] = DolPaPrice
                                InvestData['DolPaCheck'] = False
                                InvestData['Date'] = str(date)



                                NowInvestList.append(InvestData)


                                NowInvestMoney = 0
                                for iData in NowInvestList:
                                    NowInvestMoney += iData['InvestMoney']

                                InvestMoney = RemainInvestMoney + NowInvestMoney


                                print(GetStockName(stock_code, StockDataList), "(",stock_code, ") ", str(date), " " ,i, " >>>>>>>>>>>>>>>>> ë§¤ìˆ˜! ,ë§¤ìˆ˜ê¸ˆì•¡:", round(RealInvestMoney,2) , " ëŒíŒŒê°€ê²©", DolPaPrice, " ì‹œê°€:", stock_data['open'].values[0])

                    




    #ìµœëŒ€ 2ê°œ ì¢…ëª©ë§Œ íˆ¬ì ê°€ëŠ¥í•¨! ì½”ìŠ¤ë‹¥ ë§¤ìˆ˜ ì¡°ê±´ ì²´í¬!
    if len(NowInvestList) < 2 and int(date_object.strftime("%Y")) >= StartYear:

        for stock_code in all_stocks.index:

            IsAlReadyInvest = False
            for investData in NowInvestList:
                if stock_code == investData['stock_code']: 
                    IsAlReadyInvest = True
                    break    
            

            if stock_code not in today_sell_code and IsAlReadyInvest == False:

                stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)]

                 ####!!!!ì½”ìŠ¤ë‹¥ ì „ëµ!!!####
                if stock_code in ["233740","251340"]:
                    

                    PrevClosePrice = stock_data['prevClose'].values[0] 

                    DolpaRate = 0.4


                    #KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤
                    if stock_code == "251340":

                        DolpaRate = 0.2
                   
                    #KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€
                    else: 


                        if PrevClosePrice > stock_data['ma20_before'].values[0]:
                            DolpaRate = 0.3
                        else:
                            DolpaRate = 0.4

                    ##########################################################################
                    #ê°­ ìƒìŠ¹ í•˜ë½ì„ ì´ìš©í•œ ëŒíŒŒê°’ ì¡°ì ˆ!
                    # https://blog.naver.com/zacra/223277173514 ì´ í¬ìŠ¤íŒ…ì„ ì²´í¬!!!!
                    ##########################################################################
                    Gap = ((abs(stock_data['open'].values[0] - PrevClosePrice) / PrevClosePrice)) * 100.0

                    GapSt = (Gap*0.025)

                    if GapSt > 1.0:
                        GapSt = 1.0
                    if GapSt < 0:
                        GapSt = 0.1

                    if PrevClosePrice > stock_data['open'].values[0] and Gap >= 3.0:
                        DolpaRate *= (1.0 + GapSt)

                    if PrevClosePrice < stock_data['open'].values[0] and Gap >= 3.0:
                        DolpaRate *= (1.0 - GapSt)



                    #ë³€ë™ì„± ëŒíŒŒ ì‹œê°€ + (ì „ì¼ê³ ê°€-ì „ì¼ì €ê°€)* DolpaRate
                    DolPaPrice = stock_data['open'].values[0] + ((stock_data['prevHigh'].values[0] - stock_data['prevLow'].values[0]) * DolpaRate)

                    if stock_code == "251340":
                        #ë³€ë™ì„± ëŒíŒŒ ì‹œê°€ + (ì´ì „ ìº”ë“¤ 2ê°œì˜ ê³ ê°€-ì´ì „ ìº”ë“¤ 2ê°œì˜ ì €ê°€)* DolpaRate
                        DolPaPrice = stock_data['open'].values[0] + ((max(stock_data['prevHigh'].values[0],stock_data['prevHigh2'].values[0])- min(stock_data['prevLow'].values[0],stock_data['prevLow2'].values[0])) * DolpaRate)




                    IsBuyGo = False

                    DolPaRate = (DolPaPrice - stock_data['open'].values[0]) / stock_data['open'].values[0] * 100


                    if DolPaPrice <= stock_data['high'].values[0] and stock_data['open'].values[0] <= DolPaPrice  :


                        IsBuyGo = True
                        #KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤
                        if stock_code == "251340":
                            if  stock_data['prevClose'].values[0] <= stock_data['ma20_before'].values[0] :
                                IsBuyGo = False 
        

                        #KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€
                        else: 
                                
                            Disparity = stock_data['Disparity60'].values[0] 
                            
                            #í•„í„° ê°•í™”!!
                            if  (Disparity > 110 and stock_data['ma5_before'].values[0] < stock_data['ma20_before'].values[0]) or (stock_data['prevLow'].values[0] > stock_data['open'].values[0] and stock_data['prevClose'].values[0] < stock_data['ma10_before'].values[0]):
                                IsBuyGo = False 
                                
                        
                        # ì¶”ê°€ ê°œì„  ë¡œì§ https://blog.naver.com/zacra/223326173552 ì´ í¬ìŠ¤íŒ… ì°¸ê³ !!!!
                        IsJung = False    
                        if stock_data['ma10_before'].values[0] > stock_data['ma20_before'].values[0] > stock_data['ma60_before'].values[0] > stock_data['ma120_before'].values[0]:
                            IsJung = True
                            
                        if IsJung == False:
                            
                                    
                            high_price = stock_data['high_'+str(gugan_lenth)+'_max'].values[0] 
                            low_price =  stock_data['low_'+str(gugan_lenth)+'_min'].values[0] 
                            
                            Gap = (high_price - low_price) / 4
                            
                            
                            MaximunPrice = low_price + Gap * 3.0
                            
                            
                            if stock_data['open'].values[0] > MaximunPrice:
                                IsBuyGo = False
            
                        
                    #OBV í™œìš©! ì¶”ê°€ í•„í„°!
                    if IsBuyGo == True:
                        #OBV 10ì´í‰ì„ ì´ ê°ì†Œì¤‘ì´ê³  OBVê°’ì´ 10ì´í‰ì„  ì•„ë˜ì— ìˆë‹¤ë©´ ë§¤ìˆ˜ë¥¼ ì·¨ì†Œí•œë‹¤!
                        if stock_data['prev_obv_ma2'].values[0] > stock_data['prev_obv_ma'].values[0] and stock_data['prev_obv'].values[0] < stock_data['prev_obv_ma'].values[0]:
                            IsBuyGo = False
            
                            
                    if IsBuyGo == True :
          


                        Rate = 1.0
                        print("--------.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>-----")
                        print(len(Kosdaq_Long_Data), len(Kosdaq_Short_Data) )
                        print("--------.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>-----")
                        if len(Kosdaq_Long_Data) == 1 and len(Kosdaq_Short_Data) == 1:
                        
                            IsLongStrong = False
                            
                            if Kosdaq_Long_Data['Average_Momentum'].values[0] > Kosdaq_Short_Data['Average_Momentum'].values[0]:
                                IsLongStrong = True
                                
                            IsLongStrong2 = False
                            
                            if Kosdaq_Long_Data['prevChangeMa'].values[0] > Kosdaq_Short_Data['prevChangeMa'].values[0]:
                                IsLongStrong2 = True
                                
                                
                            if IsLongStrong == True and IsLongStrong2 == True:
                                
                                if stock_code == "233740":
                                    Rate = 1.3
                                else:
                                    Rate = 0.7
                                    
                            elif IsLongStrong == False and IsLongStrong2 == False:
                                    
                                if stock_code == "233740":
                                    Rate = 0.7
                                else:
                                    Rate = 1.3
                                    

                                
                        
                        AdjustRate = 1.0

                        
                        #############################################################
                        #ì‹œìŠ¤í…œ ì†ì ˆ(?) ê´€ë ¨
                        # https://blog.naver.com/zacra/223225906361 ì´ í¬ìŠ¤íŒ… ì²´í¬!!!
                        #############################################################
                        if IsCut == True and IsCutCnt >= 2:
                            
                            if stock_data['prevOpen'].values[0] > stock_data['prevClose'].values[0] and stock_data['prevHigh2'].values[0] > stock_data['prevHigh'].values[0]:
                                if IsCutCnt >= 4:
                                    AdjustRate = stock_data['Average_Momentum3'].values[0] * 0.5
                                    

                                else:
                                    AdjustRate =  stock_data['Average_Momentum3'].values[0]

                            '''
                                if IsCutCnt >= 4:
                                    AdjustRate = 0.5 + (stock_data['Average_Momentum3'].values[0] * 0.5) * 0.5
                                    

                                else:
                                    AdjustRate =  0.5 + stock_data['Average_Momentum3'].values[0] * 0.5
                            '''       
                                
                                
                                
                        print("len(NowInvestList): ", len(NowInvestList))
                        if IsNoWay == True:
                            InvestGoMoney = ((RemainInvestMoney - Kosdaq_sell_money_furture) / len(InvestStockList)) * Rate * AdjustRate

                        else:
                     
                            if len(NowInvestList) + Kosdaq_sell_cnt == 0:

                                InvestGoMoney = (RemainInvestMoney - Kosdaq_sell_money_furture) * 0.5 * Rate * AdjustRate 

                            else:
                                InvestGoMoney = (RemainInvestMoney - Kosdaq_sell_money_furture) * Rate * AdjustRate
                    
                   



                        if Rate > 0 and AdjustRate > 0:


                            BuyAmt = int(InvestGoMoney /  DolPaPrice) #ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ì„ êµ¬í•œë‹¤!

                            NowFee = (BuyAmt*DolPaPrice) * fee



                            #ë§¤ìˆ˜í•´ì•¼ ë˜ëŠ”ë° ë‚¨ì€ëˆì´ ë¶€ì¡±í•˜ë‹¤ë©´ ìˆ˜ëŸ‰ì„ í•˜ë‚˜ì”© ê°ì†Œì‹œì¼œ ë§Œì¡±í•  ë•Œ ë§¤ìˆ˜í•œë‹¤!!
                            while (RemainInvestMoney - Kosdaq_sell_money_furture)   < (BuyAmt*DolPaPrice) + NowFee:
                                if (RemainInvestMoney - Kosdaq_sell_money_furture)   > DolPaPrice:
                                    BuyAmt -= 1
                                    NowFee = (BuyAmt*DolPaPrice) * fee
                                else:
                                    break
                            
                            if BuyAmt > 0:



                                RealInvestMoney = (BuyAmt*DolPaPrice) #ì‹¤ì œ ë“¤ì–´ê°„ íˆ¬ìê¸ˆ

                                RemainInvestMoney -= (BuyAmt*DolPaPrice) #ë‚¨ì€ íˆ¬ìê¸ˆ!
                                RemainInvestMoney -= NowFee


                                InvestData = dict()

                                InvestData['stock_code'] = stock_code
                                InvestData['InvestMoney'] = RealInvestMoney
                                InvestData['FirstMoney'] = RealInvestMoney
                                InvestData['BuyPrice'] = DolPaPrice
                                InvestData['DolPaCheck'] = False
                                InvestData['Date'] = str(date)



                                NowInvestList.append(InvestData)


                                NowInvestMoney = 0
                                for iData in NowInvestList:
                                    NowInvestMoney += iData['InvestMoney']

                                InvestMoney = RemainInvestMoney + NowInvestMoney


                                print(GetStockName(stock_code, StockDataList), "(",stock_code, ") ", str(date), " " ,i, " >>>>>>>>>>>>>>>>> ë§¤ìˆ˜! ,ë§¤ìˆ˜ê¸ˆì•¡:", round(RealInvestMoney,2) , " ëŒíŒŒê°€ê²©", DolPaPrice, " ì‹œê°€:", stock_data['open'].values[0])

        





    
    NowInvestMoney = 0

    for iData in NowInvestList:
        NowInvestMoney += iData['InvestMoney']



    InvestMoney = RemainInvestMoney + NowInvestMoney

    InvestCoinListStr = ""
    #print("\n\n------------------------------------")
    for iData in NowInvestList:
        InvestCoinListStr += GetStockName(iData['stock_code'], StockDataList)  + " "




   # print("------------------------------------\n\n")



    


    print("\n\n>>>>>>>>>>>>", InvestCoinListStr, "---> íˆ¬ìê°œìˆ˜ : ", len(NowInvestList))
    pprint.pprint(NowInvestList)
    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>--))", str(date), " ì”ê³ :",str(InvestMoney) , "=" , str(RemainInvestMoney) , "+" , str(NowInvestMoney), "\n\n" )
    

    TotalMoneyList.append(InvestMoney)

    #####################################################
    #####################################################
    #####################################################
    #'''
    
   


#ê²°ê³¼ ì •ë¦¬ ë° ë°ì´í„° ë§Œë“¤ê¸°!!
if len(TotalMoneyList) > 0:

    print("TotalMoneyList -> ", len(TotalMoneyList))


    resultData = dict()

    # Create the result DataFrame with matching shapes
    result_df = pd.DataFrame({"Total_Money": TotalMoneyList}, index=combined_df.index.unique())

    result_df['Ror'] = np.nan_to_num(result_df['Total_Money'].pct_change()) + 1
    result_df['Cum_Ror'] = result_df['Ror'].cumprod()
    result_df['Highwatermark'] = result_df['Cum_Ror'].cummax()
    result_df['Drawdown'] = (result_df['Cum_Ror'] / result_df['Highwatermark']) - 1
    result_df['MaxDrawdown'] = result_df['Drawdown'].cummin()

    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")
    pprint.pprint(result_df)
    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")

    resultData['DateStr'] = str(FirstDateStr) + " ~ " + str(result_df.iloc[-1].name)

    resultData['OriMoney'] = result_df['Total_Money'].iloc[0]
    resultData['FinalMoney'] = result_df['Total_Money'].iloc[-1]
    resultData['RevenueRate'] = ((result_df['Cum_Ror'].iloc[-1] -1.0)* 100.0)

    resultData['MDD'] = result_df['MaxDrawdown'].min() * 100.0

    resultData['TryCnt'] = TryCnt
    resultData['SuccesCnt'] = SuccesCnt
    resultData['FailCnt'] = FailCnt

    # CAGR ê³„ì‚°
    start_date = pd.to_datetime(result_df.index[0])
    end_date = pd.to_datetime(result_df.index[-1])
    years = (end_date - start_date).days / 365.25
    resultData['CAGR'] = ((resultData['FinalMoney'] / resultData['OriMoney']) ** (1/years) - 1) * 100


    ResultList.append(resultData)

    
    result_df.index = pd.to_datetime(result_df.index)
    # Create a figure with subplots for the two charts
    fig, axs = plt.subplots(2, 1, figsize=(10, 10))

    # Plot the return chart
    axs[0].plot(result_df['Cum_Ror'] * 100, label='Strategy')
    axs[0].set_ylabel('Cumulative Return (%)')
    axs[0].set_title('Return Comparison Chart')
    axs[0].legend()

    # Plot the MDD and DD chart on the same graph
    axs[1].plot(result_df.index, result_df['MaxDrawdown'] * 100, label='MDD')
    axs[1].plot(result_df.index, result_df['Drawdown'] * 100, label='Drawdown')
    axs[1].set_ylabel('Drawdown (%)')
    axs[1].set_title('Drawdown Comparison Chart')
    axs[1].legend()

    # Show the plot
    plt.tight_layout()
    plt.show()
        
    


    for idx, row in result_df.iterrows():
        print(idx, " " , row['Total_Money'], " "  , row['Cum_Ror'])
        



#ë°ì´í„°ë¥¼ ë³´ê¸°ì¢‹ê²Œ í”„ë¦°íŠ¸ í•´ì£¼ëŠ” ë¡œì§!
print("\n\n--------------------")


for result in ResultList:

    print("--->>>",result['DateStr'].replace("00:00:00",""),"<<<---")

    for stock_data in StockDataList:
        print(stock_data['stock_name'] , " (", stock_data['stock_code'],")")
        if stock_data['try'] > 0:
            print("ì„±ê³µ:", stock_data['success'] , " ì‹¤íŒ¨:", stock_data['fail']," -> ìŠ¹ë¥ : ", round(stock_data['success']/stock_data['try'] * 100.0,2) ," %")
            print("ë§¤ë§¤ë‹¹ í‰ê·  ìˆ˜ìµë¥ :", round(stock_data['accRev']/ stock_data['try'],2) )
        print()

    print("---------- ì´ ê²°ê³¼ ----------")
    print("ìµœì´ˆ ê¸ˆì•¡:", format(int(round(result['OriMoney'],0)), ',') , " ìµœì¢… ê¸ˆì•¡:", format(int(round(result['FinalMoney'],0)), ','), " \nìˆ˜ìµë¥ :", round(((round(result['FinalMoney'],2) - round(result['OriMoney'],2) ) / round(result['OriMoney'],2) ) * 100,2) ,"% MDD:",  round(result['MDD'],2),"%")
    if result['TryCnt'] > 0:
        print("ì„±ê³µ:", result['SuccesCnt'] , " ì‹¤íŒ¨:", result['FailCnt']," -> ìŠ¹ë¥ : ", round(result['SuccesCnt']/result['TryCnt'] * 100.0,2) ," %")
    print("ì—°ë³µë¦¬ìˆ˜ìµë¥ (CAGR):", format(round(result['CAGR'],2), ','), "%\n")
    
    # ì›”ë³„ ìˆ˜ìµë¥  ê³„ì‚° ë° ì¶œë ¥
    print("\n---------- ì›”ë³„ ìˆ˜ìµë¥  ----------")
    monthly_ror = result_df['Ror'].resample('M').apply(lambda x: (x.prod() - 1) * 100)
    for month, ror in monthly_ror.items():
        if not pd.isna(ror):
            print(f"{month.strftime('%Y-%m')}: {ror:>7.2f}%")
    
    # ë…„ë„ë³„ ìˆ˜ìµë¥  ê³„ì‚° ë° ì¶œë ¥
    print("\n---------- ë…„ë„ë³„ ìˆ˜ìµë¥  ----------")
    yearly_ror = result_df['Ror'].resample('Y').apply(lambda x: (x.prod() - 1) * 100)
    for year, ror in yearly_ror.items():
        if not pd.isna(ror):
            print(f"{year.strftime('%Y')}: {ror:>7.2f}%")
    
    print("------------------------------")
    print("####################################")
